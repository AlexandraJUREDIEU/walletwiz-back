// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

/// R√¥les possibles d‚Äôun membre dans une session.
enum MemberRole {
  OWNER        /// Propri√©taire (si tu veux le repr√©senter aussi comme Member)
  COLLABORATOR /// Peut √©diter (collaborateur)
  VIEWER       /// Lecture seule (lecteur)
}

/// Statut de l‚Äôinvitation (si utilis√©e).
enum InvitationStatus {
  PENDING
  ACCEPTED
  DECLINED
}

/// Cat√©gories possibles d‚Äôune d√©pense (extensible si besoin).
enum ExpenseCategory {
  HOUSING       /// Loyer / Cr√©dit
  UTILITIES     /// Eau / √âlectricit√© / Gaz
  HEALTH        /// Mutuelle / Frais m√©dicaux
  FOOD          /// Courses / Restaurants
  TRANSPORT     /// Essence / Parking / Entretien
  SUBSCRIPTIONS /// Abonnements (Netflix, Spotify‚Ä¶)
  OTHER         /// Divers
}


/// Repr√©sente un utilisateur inscrit dans WalletWiz.
/// Peut cr√©er des sessions ou √™tre invit√© √† en rejoindre.
/// Sert de base √† l'authentification et aux relations avec les membres.
model Users {
  
  id                        String @id @default(cuid())                     /// ID unique de l'utilisateur (CUID).
  email                     String @unique                                  /// Adresse email de connexion (unique).
  password                  String                                          /// Mot de passe hash√©.
  firstName                 String?                                         /// Pr√©nom de l'utilisateur (optionnel).
  lastName                  String?                                         /// Nom de l'utilisateur (optionnel).
  status                    String?                                         /// Statut de compte (optionnel - ex : actif, d√©sactiv√©).
  avatarUrl                 String?                                         /// URL de l‚Äôavatar utilisateur (optionnel).
  emailVerified             Boolean @default(false)                         /// Bool√©en indiquant si l‚Äôemail a √©t√© v√©rifi√©.
  verificationCode          String?                                         /// Code de v√©rification envoy√© par email (optionnel).
  verificationExpiresAt     DateTime?                                       /// Date d‚Äôexpiration du code de v√©rification.
  resetToken                String? @unique                                 /// Token de r√©initialisation du mot de passe (unique, optionnel).
  resetExpiresAt            DateTime?                                       /// Date d‚Äôexpiration du token de r√©initialisation.
  createdAt                 DateTime @default(now())                        /// Date de cr√©ation du compte.
  updatedAt                 DateTime @updatedAt                             /// Date de derni√®re mise √† jour du compte.

  /// Relations
  sessionsOwned             Sessions[] @relation("UserOwnedSessions")       /// Sessions cr√©√©es par cet utilisateur.
  membres                   Members[]                                       /// Liste des rattachements en tant que membre de sessions.
}


/// Repr√©sente une session de gestion partag√©e dans WalletWiz.
/// Une session regroupe les comptes, revenus, d√©penses, membres, etc.
/// Chaque session est cr√©√©e par un utilisateur (owner).
model Sessions {

  id           String    @id @default(cuid())                                                 /// ID unique de la session.
  name         String?                                                                        /// Nom de la session (optionnel).
  ownerId      String                                                                         /// ID de l‚Äôutilisateur cr√©ateur de la session.
  isDefault    Boolean  @default(false)                                                       /// Indique si cette session est celle par d√©faut de l‚Äôutilisateur.
  createdAt    DateTime  @default(now())                                                      /// Date de cr√©ation de la session.
  updatedAt    DateTime  @updatedAt                                                           /// Date de derni√®re mise √† jour.

  /// Relations
  owner           Users      @relation("UserOwnedSessions", fields: [ownerId], references: [id])   /// Propri√©taire de la session.
  members         Members[]                                                                        /// Membres rattach√©s √† cette session.
  bankAccounts    BankAccounts[]        
  incomes         Incomes[]                                                                        /// Revenus rattach√©s √† cette session.                                                           /// Comptes bancaires rattach√©s √† cette session.
  expenses        Expenses[]                                                                       /// D√©penses rattach√©es √† cette session.
}


/// Repr√©sente un membre rattach√© √† une session WalletWiz.
/// Peut √™tre un utilisateur r√©el (userId) ou un membre fictif (sans user, avec un nom libre).
/// G√®re aussi la m√©canique d‚Äôinvitation via inviteToken (lien copiable).
model Members {
  id                    String           @id @default(cuid())                     /// ID unique du membre de session (CUID).
  sessionId             String                                                    /// ID de la session concern√©e.
  userId                String?                                                   /// ID de l'utilisateur WalletWiz (optionnel si membre fictif).
  name                  String?                                                   /// Nom affich√© si membre fictif ou alias (optionnel).
  role                  MemberRole        @default(COLLABORATOR)                  /// R√¥le dans la session (collaborateur, lecteur‚Ä¶).
  isPlaceholder         Boolean           @default(false)                         /// True si membre fictif (non li√© √† un user).
  invitationStatus      InvitationStatus  @default(PENDING)                       /// Statut de l‚Äôinvitation si utilis√©e.
  invitedEmail          String?                                                   /// Email d‚Äôinvitation (optionnel, si utilis√©).
  inviteToken           String?           @unique                                 /// Jeton d‚Äôinvitation (lien copiable), optionnel.
  invitedAt             DateTime?                                                 /// Date d‚Äôenvoi de l‚Äôinvitation (optionnelle).
  acceptedAt            DateTime?                                                 /// Date d‚Äôacceptation (optionnelle).
  createdAt             DateTime          @default(now())                         /// Date de cr√©ation du rattachement.
  updatedAt             DateTime          @updatedAt                              /// Date de derni√®re mise √† jour.

  /// Relations
  session               Sessions           @relation(fields: [sessionId], references: [id], onDelete : Cascade)   /// Session √† laquelle le membre est rattach√©, supprime le membre si la session est supprim√©.
  user                  Users?             @relation(fields: [userId], references: [id])                          /// Utilisateur li√© (si r√©el).
  bankAccounts          BankAccountMembers[]                                                                      /// Comptes joints auxquels ce membre est rattach√©.
  incomes               Incomes[]                                                                                 /// Revenus per√ßus par ce membre.
  expenses              Expenses[]                                                                                /// D√©penses port√©es par ce membre.


  @@unique([sessionId, userId])                                                               /// Un m√™me user ne peut √™tre que 1x dans une session.
  @@index([sessionId])
  @@index([userId])
}

/// Repr√©sente un compte bancaire rattach√© √† une session WalletWiz.
/// Peut √™tre partag√© (compte joint) entre plusieurs membres via la table pivot BankAccountMember.
/// Sert de support aux flux financiers (revenus/d√©penses) ‚Äî non g√©r√©s pour l‚Äôinstant.
model BankAccounts {

  id              String             @id @default(cuid())                       /// ID unique du compte (CUID).
  label           String                                                        /// Libell√© du compte (ex: "Compte courant").
  bankName        String                                                        /// Nom de la banque (ex: "BNP", "Soci√©t√© G√©n√©rale").
  sessionId       String                                                        /// ID de la session propri√©taire du compte.
  initialBalance  Decimal            @db.Decimal(18, 2) @default(0)             /// Solde initial du compte (pr√©cis, d√©cimal).
  isArchived      Boolean            @default(false)                            /// Indique si le compte est archiv√© (inactif).
  createdAt       DateTime           @default(now())                            /// Date de cr√©ation du compte.
  updatedAt       DateTime           @updatedAt                                 /// Date de derni√®re mise √† jour.

  /// Relations
  session         Sessions            @relation(fields: [sessionId], references: [id])   /// Session √† laquelle le compte appartient.
  members         BankAccountMembers[]                                                   /// Membres associ√©s (compte joint).
  incomes         Incomes[]                                                              /// Revenus vers√©s sur ce compte.
  expenses        Expenses[]                                                             /// D√©penses d√©bit√©es sur ce compte.


  @@index([sessionId])
}

/// Table pivot entre BankAccount et Member pour g√©rer les comptes joints.
/// Un compte peut avoir plusieurs membres, et un membre peut √™tre rattach√© √† plusieurs comptes.
model BankAccountMembers {
  bankAccountId   String                                                     /// ID du compte.
  memberId        String                                                     /// ID du membre.
  createdAt       DateTime            @default(now())                        /// Date de rattachement au compte.

  bankAccount     BankAccounts         @relation(fields: [bankAccountId], references: [id], onDelete: Cascade) /// Supprime le lien si le compte est supprim√©.
  member          Members              @relation(fields: [memberId], references: [id], onDelete: Cascade)      /// Supprime le lien si le membre est supprim√©.

  @@id([bankAccountId, memberId])                                                                             /// Cl√© composite unique.
  @@index([memberId])
}

/// Repr√©sente un revenu rattach√© √† une session.
/// Le revenu appartient √† un membre et est vers√© sur un compte bancaire.
model Incomes {

  id            String      @id @default(cuid())                  /// ID unique du revenu (CUID).
  label         String                                           /// Intitul√© du revenu (ex: "Salaire").
  amount        Decimal     @db.Decimal(18, 2)                    /// Montant du revenu (d√©cimal pr√©cis).
  day           Int                                              /// Jour du mois pr√©vu (1‚Äì31).
  sessionId     String                                           /// ID de la session.
  memberId      String                                           /// ID du membre b√©n√©ficiaire.
  bankAccountId String                                           /// ID du compte bancaire de versement.
  createdAt     DateTime    @default(now())                      /// Date de cr√©ation.
  updatedAt     DateTime    @updatedAt                           /// Date de derni√®re mise √† jour.

  /// Relations
  session       Sessions     @relation(fields: [sessionId], references: [id])     /// Session li√©e.
  member        Members      @relation(fields: [memberId], references: [id])      /// Membre concern√©.
  bankAccount   BankAccounts @relation(fields: [bankAccountId], references: [id]) /// Compte de versement.

  @@index([sessionId])
  @@index([memberId])
  @@index([bankAccountId])
}

/// Repr√©sente une d√©pense rattach√©e √† une session.
/// La d√©pense appartient √† un membre et est d√©bit√©e d‚Äôun compte bancaire.
model Expenses {

  id            String        @id @default(cuid())                         /// ID unique de la d√©pense (CUID).
  label         String                                                        /// Intitul√© de la d√©pense (ex: "Loyer").
  amount        Decimal       @db.Decimal(18, 2)                              /// Montant de la d√©pense (d√©cimal pr√©cis).
  day           Int                                                           /// Jour pr√©vu (1‚Äì31).
  category      ExpenseCategory                                               /// Cat√©gorie de la d√©pense.
  isArchived    Boolean       @default(false)                                 /// True si la d√©pense est archiv√©e (inactive).

  sessionId     String                                                        /// ID de la session.
  memberId      String                                                        /// ID du membre porteur de la d√©pense.
  bankAccountId String                                                        /// ID du compte bancaire d√©bit√©.

  createdAt     DateTime      @default(now())                                 /// Date de cr√©ation.
  updatedAt     DateTime      @updatedAt                                      /// Date de derni√®re mise √† jour.

  /// Relations
  session       Sessions       @relation(fields: [sessionId], references: [id])     /// Session li√©e.
  member        Members        @relation(fields: [memberId], references: [id])      /// Membre concern√©.
  bankAccount   BankAccounts   @relation(fields: [bankAccountId], references: [id]) /// Compte d√©bit√©.

  @@index([sessionId])
  @@index([memberId])
  @@index([bankAccountId])

  /// üëÆüèª‚Äç‚ôÄÔ∏è Contr√¥le de doublon exact dans une m√™me session
  /// Emp√™che d‚Äôenregistrer deux fois la m√™me d√©pense (m√™me label, jour et montant).
  @@unique([sessionId, label, day, amount])
}